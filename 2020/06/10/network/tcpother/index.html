<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="随缘更新的博客,就当做是备忘录了"/>
    

    <!--Author-->
    
        <meta name="author" content="Ryan Chen"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="TCP扩展学习"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="随缘更新的博客,就当做是备忘录了"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Ryan&#39;s Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/home-bg.jpg"/>
    

    <!-- Title -->
    
    <title>TCP扩展学习 - Ryan&#39;s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
    <link rel="icon" href="/img/favicon.png"/>
    

<meta name="generator" content="Hexo 4.2.0"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Let It Be</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags">
                            
                                Tags
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            
                                Categories
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            
                                About
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/home-bg.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>TCP扩展学习</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                            Posted by Ryan Chen on
                        
                        
                            2020-06-10
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/TCP-IP/">#TCP/IP</a> <a href="/tags/网络/">#网络</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/知识积累/">知识积累</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h2 id="半连接队列、全连接队列基本概念"><a href="#半连接队列、全连接队列基本概念" class="headerlink" title="半连接队列、全连接队列基本概念"></a>半连接队列、全连接队列基本概念</h2><p>为了理解 backlog，我们需要了解 listen 和 accept 函数背后的发生了什么。backlog 参数跟 listen 函数有关，listen 函数的定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int listen(int sockfd, int backlog);</span><br></pre></td></tr></table></figure>

<p>当服务端调用 listen 函数时，TCP 的状态被从 CLOSE 状态变为 LISTEN，于此同时内核创建了两个队列：</p>
<ul>
<li>半连接队列（Incomplete connection queue），又称 SYN 队列</li>
<li>全连接队列（Completed connection queue），又称 Accept 队列</li>
</ul>
<p>如下图所示。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/28/16b9dae5efc47de8?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h2 id="SYN-flood-攻击"><a href="#SYN-flood-攻击" class="headerlink" title="SYN flood 攻击"></a>SYN flood 攻击</h2><p>SYN Flood 是一种广为人知的 DoS（拒绝服务攻击） 想象一个场景：客户端大量伪造 IP 发送 SYN 包，服务端回复的 ACK+SYN 去到了一个「未知」的 IP 地址，势必会造成服务端大量的连接处于 SYN_RCVD 状态，而服务器的半连接队列大小也是有限的，如果半连接队列满，也会出现无法处理正常请求的情况。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/29/16ba36e681b24ff3?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>在客户端用 scapy 执行的 sr1 函数向目标机器（10.211.55.5）发起 SYN 包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sr1(IP(src&#x3D;&quot;23.16.*.*&quot;, dst&#x3D;&quot;10.211.55.10&quot;) &#x2F; TCP(dport&#x3D;80, flags&#x3D;&quot;S&quot;) )</span><br></pre></td></tr></table></figure>

<p>其中服务端收到的 SYN 包的源地址将会是 23.16 网段内的随机 IP，隐藏了自己的 IP。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnpat | grep :80</span><br><span class="line"></span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 10.211.55.10:80         23.16.63.3:20           SYN_RECV    -</span><br><span class="line">tcp        0      0 10.211.55.10:80         23.16.64.3:20           SYN_RECV    -</span><br><span class="line">tcp        0      0 10.211.55.10:80         23.16.62.3:20           SYN_RECV    -</span><br></pre></td></tr></table></figure>

<p>在服务端抓包看到下面的抓包</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/29/16ba36e689c9cae6?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>可以看到短时间内，服务端收到了很多虚假 IP 的 SYN 包，马上回复了 SYN+ACK 给这些虚假 IP 的服务器。这些虚假的 IP 当然一脸懵逼，我都没发 SYN，你给我发 SYN+ACK 干嘛，于是马上回了 RST。</p>
<p>使用 netstat 查看服务器的状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">netstat -lnpat | grep :80</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 10.211.55.10:80         23.16.63.3:20           SYN_RECV    -</span><br><span class="line">tcp        0      0 10.211.55.10:80         23.16.64.3:20           SYN_RECV    -</span><br><span class="line">tcp        0      0 10.211.55.10:80         23.16.62.3:20           SYN_RECV    -</span><br></pre></td></tr></table></figure>

<p>服务端的 SYN_RECV 的数量偶尔涨起来又降下去，因为对端回了 RST 包，这条连接在收到 RST 以后就被从半连接队列清除了。如果攻击者控制了大量的机器，同时发起 SYN，依然会对服务器造成不小的影响。</p>
<p>而且 <code>SYN+ACK</code> 去到的不知道是哪里的主机，是否回复 RST 完全取决于它自己，万一它不直接忽略掉 SYN，不回复 RST，问题就更严重了。服务端以为自己的 SYN+ACK 丢失了，会进行重传。</p>
<p>我们来模拟一下这种场景。因为没有办法在去 <code>SYN+ACK</code> 包去到的主机的配置，可以在服务器用 iptables 墙掉主机发过来的 RST 包，模拟主机没有回复 RST 包的情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  iptables --append INPUT  --match tcp --protocol tcp --dst 10.211.55.10 --dport 80 --tcp-flags RST RST --jump DROP</span><br></pre></td></tr></table></figure>

<p>这个时候再次使用 netstat 查看，满屏的 SYN_RECV 出现了</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/29/16ba36e691c556be?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>通过服务端抓包的文件也可以看到，服务端因为 SYN+ACK 丢了，然后进行重传。重传的次数由<code>/proc/sys/net/ipv4/tcp_synack_retries</code>文件决定，在我的 Centos 上这个默认值为 5。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/29/16ba36e68300ff13?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>重传 5 次 SYN+ACK 包，重传的时间依然是指数级退避（1s、2s、4s、8s、16s），发送完最后一次 SYN+ACK 包以后，等待 32s，服务端才会丢弃掉这个连接，把处于SYN_RECV 状态的 socket 关闭。</p>
<p>在这种情况下，一次恶意的 SYN 包，会占用一个服务端连接 63s（1+2+4+8+16+32），如果这个时候有大量的恶意 SYN 包过来连接服务器，很快半连接队列就被占满，不能接收正常的用户请求。</p>
<h2 id="如何应对-SYN-Flood-攻击"><a href="#如何应对-SYN-Flood-攻击" class="headerlink" title="如何应对 SYN Flood 攻击"></a>如何应对 SYN Flood 攻击</h2><p>常见的有下面这几种方法</p>
<h4 id="增加-SYN-连接数：tcp-max-syn-backlog"><a href="#增加-SYN-连接数：tcp-max-syn-backlog" class="headerlink" title="增加 SYN 连接数：tcp_max_syn_backlog"></a>增加 SYN 连接数：tcp_max_syn_backlog</h4><p>调大<code>net.ipv4.tcp_max_syn_backlog</code>的值，不过这只是一个心理安慰，真有攻击的时候，这个再大也不够用。</p>
<h4 id="减少SYN-ACK重试次数：tcp-synack-retries"><a href="#减少SYN-ACK重试次数：tcp-synack-retries" class="headerlink" title="减少SYN+ACK重试次数：tcp_synack_retries"></a>减少<code>SYN+ACK</code>重试次数：tcp_synack_retries</h4><p>重试次数由 <code>/proc/sys/net/ipv4/tcp_synack_retries</code>控制，默认情况下是 5 次，当收到<code>SYN+ACK</code>故意不回 ACK 或者回复的很慢的时候，调小这个值很有必要。</p>
<h2 id="SYN-Cookie-机制"><a href="#SYN-Cookie-机制" class="headerlink" title="SYN Cookie 机制"></a>SYN Cookie 机制</h2><p>SYN Cookie 技术最早是在 1996 年提出的，最早就是用来解决 SYN Flood 攻击的，现在服务器上的 tcp_syncookies 都是默认等于 1，表示连接队列满时启用，等于 0 表示禁用，等于 2 表示始终启用。由<code>/proc/sys/net/ipv4/tcp_syncookies</code>控制。</p>
<p>SYN Cookie 机制其实原理比较简单，就是在三次握手的最后阶段才分配连接资源，如下图所示。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/6/29/16ba36e691d04901?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>SYN Cookie 的原理是基于「无状态」的机制，服务端收到 SYN 包以后不马上分配为 <code>Inbound SYN</code>分配内存资源，而是根据这个 SYN 包计算出一个 Cookie 值，作为握手第二步的序列号回复 SYN+ACK，等对方回应 ACK 包时校验回复的 ACK 值是否合法，如果合法才三次握手成功，分配连接资源。</p>
<h2 id="TFO-简介"><a href="#TFO-简介" class="headerlink" title="TFO 简介"></a>TFO 简介</h2><p>TFO 是在原来 TCP 协议上的扩展协议，它的主要原理就在发送第一个 SYN 包的时候就开始传数据了，不过它要求当前客户端之前已经完成过「正常」的三次握手。快速打开分两个阶段：请求 Fast Open Cookie 和 真正开始 TCP Fast Open</p>
<p>请求 Fast Open Cookie 的过程如下：</p>
<ul>
<li>客户端发送一个 SYN 包，头部包含 Fast Open 选项，且该选项的Cookie 为空，这表明客户端请求 Fast Open Cookie</li>
<li>服务端收取 SYN 包以后，生成一个 cookie 值（一串字符串）</li>
<li>服务端发送 SYN + ACK 包，在 Options 的 Fast Open 选项中设置 cookie 的值</li>
<li>客户端缓存服务端的 IP 和收到的 cookie 值</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/3/169e2dc0888e6b83?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>第一次过后，客户端就有了缓存在本地的 cookie 值，后面的握手和数据传输过程如下：</p>
<ul>
<li>客户端发送 SYN 数据包，里面包含数据和之前缓存在本地的 Fast Open Cookie。（注意我们此前介绍的所有 SYN 包都不能包含数据）</li>
<li>服务端检验收到的 TFO Cookie 和传输的数据是否合法。如果合法就会返回 SYN + ACK 包进行确认并将数据包传递给应用层，如果不合法就会丢弃数据包，走正常三次握手流程（只会确认 SYN）</li>
<li>服务端程序收到数据以后可以握手完成之前发送响应数据给客户端了</li>
<li>客户端发送 ACK 包，确认第二步的 SYN 包和数据（如果有的话）</li>
<li>后面的过程就跟非 TFO 连接过程一样了</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/3/169e2dc0821ff4f9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<h2 id="TCP-Fast-Open-的优势"><a href="#TCP-Fast-Open-的优势" class="headerlink" title="TCP Fast Open 的优势"></a>TCP Fast Open 的优势</h2><p>一个最显著的优点是可以利用握手去除一个往返 RTT，如下图所示</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/4/3/169e2dc0c15f46e5?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img"></p>
<p>在开启 TCP Fast Open以后，从第二次请求开始，就可以在一个 RTT 时间拿到响应的数据。</p>
<p>还有一些其它的优点，比如可以防止 SYN-Flood 攻击之类的。</p>
<ol>
<li>客户端发送一个 SYN 包，头部包含 Fast Open 选项，且该选项的 Cookie 长度为 0</li>
<li>服务端根据客户端 IP 生成 cookie，放在 SYN+ACK 包中一同发回客户端</li>
<li>客户端收到 Cookie 以后缓存在自己的本地内存</li>
<li>客户端再次访问服务端时，在 SYN 包携带数据，并在头部包含 上次缓存在本地的 TCP cookie</li>
<li>如果服务端校验 Cookie 合法，则在客户端回复 ACK 前就可以直接发送数据。如果 Cookie 不合法则按照正常三次握手进行。</li>
</ol>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                        <li>
                            <a href="https://mobile.twitter.com/ZhikuanCccccc" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://500px.com/kaido4894" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-500px fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://github.com/ryanchenzhikuan/ryanchenzhikuan.github.io" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="https://www.instagram.com/ryanchenzk/" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                        <li>
                            <a href="mailto:kaido4894@gmail.com" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 Ryan Chen<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>